# 前端接口修改文档

## 📋 概述

根据重新设计的路径规划，前端接口已经进行了优化分类。本文档详细说明了前端需要调用的各类接口，以及它们的认证方式和使用方法。

**基础URL**: `http://localhost:8090`

---

## 🔄 路径变更说明

### ✅ 无需修改的接口
大部分前端业务接口**无需修改**，继续使用原有路径：

- `/api/user/**` - 用户管理相关
- `/api/interfaceInfo/**` - 接口信息管理
- `/api/analysis/**` - 数据分析相关
- `/user/**` - 用户认证相关
- `/interfaceInfo/**` - 接口操作相关

### 📝 新增的接口分类
- `/third-party/**` - 第三方API调用（如果前端需要直接调用）

---

## 🔐 认证方式说明

### 1. Session认证（推荐）
**适用接口**: 所有平台业务接口和调试接口
**认证方式**: 自动携带Cookie中的Session
**用户体验**: 最佳，无需手动管理密钥

### 2. 密钥认证
**适用接口**: 第三方API直接调用（较少使用）
**认证方式**: 请求头携带accessKey和签名
**用户体验**: 复杂，需要手动处理签名

---

## 📡 平台业务接口 (Session认证)

### 1. 用户管理接口

#### 1.1 用户注册
**接口路径**: `POST /user/register`  
**认证要求**: 无  
**请求示例**:
```javascript
const register = async (userData) => {
  const response = await fetch('/user/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userAccount: userData.userAccount,
      userPassword: userData.userPassword,
      checkPassword: userData.checkPassword
    })
  });
  return response.json();
};
```

#### 1.2 用户登录
**接口路径**: `POST /user/login`  
**认证要求**: 无  
**请求示例**:
```javascript
const login = async (loginData) => {
  const response = await fetch('/user/login', {
    method: 'POST',
    credentials: 'include', // 重要：保存Session Cookie
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userAccount: loginData.userAccount,
      userPassword: loginData.userPassword
    })
  });
  return response.json();
};
```

#### 1.3 获取当前用户
**接口路径**: `GET /user/get/login`  
**认证要求**: Session  
**请求示例**:
```javascript
const getCurrentUser = async () => {
  const response = await fetch('/user/get/login', {
    credentials: 'include' // 自动携带Session
  });
  return response.json();
};
```

#### 1.4 用户登出
**接口路径**: `POST /user/logout`  
**认证要求**: 无  
**请求示例**:
```javascript
const logout = async () => {
  const response = await fetch('/user/logout', {
    method: 'POST',
    credentials: 'include'
  });
  return response.json();
};
```

### 2. 用户密钥管理接口

#### 2.1 查看API密钥
**接口路径**: `GET /user/get/keys`  
**认证要求**: Session  
**请求示例**:
```javascript
const getUserKeys = async () => {
  const response = await fetch('/user/get/keys', {
    credentials: 'include'
  });
  return response.json();
};
```

#### 2.2 生成API密钥
**接口路径**: `POST /user/generate/keys`  
**认证要求**: Session  
**请求示例**:
```javascript
const generateKeys = async () => {
  const response = await fetch('/user/generate/keys', {
    method: 'POST',
    credentials: 'include'
  });
  return response.json();
};
```

#### 2.3 重新生成API密钥
**接口路径**: `POST /user/regenerate/keys`  
**认证要求**: Session  
**请求示例**:
```javascript
const regenerateKeys = async () => {
  if (confirm('重新生成密钥将使旧密钥失效，确定继续？')) {
    const response = await fetch('/user/regenerate/keys', {
      method: 'POST',
      credentials: 'include'
    });
    return response.json();
  }
};
```

### 3. 接口信息管理接口

#### 3.1 分页获取接口列表 ⭐
**接口路径**: `POST /api/interfaceInfo/list/page/vo`  
**认证要求**: Session  
**请求示例**:
```javascript
const getInterfaceList = async (params) => {
  const response = await fetch('/api/interfaceInfo/list/page/vo', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      current: params.current || 1,
      pageSize: params.pageSize || 10,
      name: params.name,
      description: params.description,
      method: params.method,
      status: params.status
    })
  });
  return response.json();
};

// 使用示例 - 你的分页查询
const result = await getInterfaceList({
  current: 1,
  pageSize: 5
});
```

#### 3.2 获取接口详情
**接口路径**: `GET /api/interfaceInfo/get/vo`  
**认证要求**: Session  
**请求示例**:
```javascript
const getInterfaceDetail = async (id) => {
  const response = await fetch(`/api/interfaceInfo/get/vo?id=${id}`, {
    credentials: 'include'
  });
  return response.json();
};
```

#### 3.3 创建接口
**接口路径**: `POST /api/interfaceInfo/add`  
**认证要求**: Session  
**请求示例**:
```javascript
const createInterface = async (interfaceData) => {
  const response = await fetch('/api/interfaceInfo/add', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(interfaceData)
  });
  return response.json();
};
```

#### 3.4 更新接口
**接口路径**: `POST /api/interfaceInfo/update`  
**认证要求**: Session + 管理员权限  
**请求示例**:
```javascript
const updateInterface = async (interfaceData) => {
  const response = await fetch('/api/interfaceInfo/update', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(interfaceData)
  });
  return response.json();
};
```

#### 3.5 接口上线
**接口路径**: `POST /api/interfaceInfo/online`  
**认证要求**: Session + 管理员权限  
**请求示例**:
```javascript
const onlineInterface = async (id) => {
  const response = await fetch('/api/interfaceInfo/online', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ id })
  });
  return response.json();
};
```

#### 3.6 接口下线
**接口路径**: `POST /api/interfaceInfo/offline`  
**认证要求**: Session + 管理员权限  
**请求示例**:
```javascript
const offlineInterface = async (id) => {
  const response = await fetch('/api/interfaceInfo/offline', {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ id })
  });
  return response.json();
};
```

### 4. 接口调试功能 ⭐

#### 4.1 调用接口（平台内调试）
**接口路径**: `POST /interfaceInfo/invoke`  
**认证要求**: Session  
**特点**: 自动使用登录用户的密钥，无需手动输入  
**请求示例**:
```javascript
const invokeInterface = async (interfaceId, params) => {
  const response = await fetch('/interfaceInfo/invoke', {
    method: 'POST',
    credentials: 'include', // 自动使用Session认证
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      id: interfaceId,
      userRequestParams: JSON.stringify(params)
    })
  });
  return response.json();
};

// 使用示例
const result = await invokeInterface(1, { name: "张三" });
```

#### 4.2 获取可用API列表
**接口路径**: `GET /interfaceInfo/available-apis`  
**认证要求**: Session  
**请求示例**:
```javascript
const getAvailableApis = async () => {
  const response = await fetch('/interfaceInfo/available-apis', {
    credentials: 'include'
  });
  return response.json();
};
```

### 5. 数据分析接口

#### 5.1 获取接口调用排行
**接口路径**: `GET /api/analysis/top/interface/invoke`  
**认证要求**: Session + 管理员权限  
**请求示例**:
```javascript
const getTopInvokeInterfaces = async () => {
  const response = await fetch('/api/analysis/top/interface/invoke', {
    credentials: 'include'
  });
  return response.json();
};
```

---

## 🛠️ 前端开发最佳实践

### 1. 统一请求封装
```javascript
// api.js - 统一API调用封装
class ApiClient {
  constructor(baseURL = '') {
    this.baseURL = baseURL;
  }

  async request(url, options = {}) {
    const config = {
      credentials: 'include', // 始终携带Session Cookie
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    };

    try {
      const response = await fetch(this.baseURL + url, config);
      const result = await response.json();
      
      // 统一错误处理
      if (result.code !== 0) {
        this.handleError(result);
        throw new Error(result.message || '请求失败');
      }
      
      return result.data;
    } catch (error) {
      console.error('API请求错误:', error);
      throw error;
    }
  }

  handleError(result) {
    switch (result.code) {
      case 40101:
        // 未登录，跳转到登录页
        window.location.href = '/login';
        break;
      case 40102:
        alert('无权限访问');
        break;
      case 40000:
        alert('参数错误');
        break;
      default:
        alert(result.message || '操作失败');
    }
  }

  // GET请求
  get(url, params = {}) {
    const query = new URLSearchParams(params).toString();
    const fullUrl = query ? `${url}?${query}` : url;
    return this.request(fullUrl);
  }

  // POST请求
  post(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }
}

// 创建API客户端实例
const api = new ApiClient();
export default api;
```

### 2. 业务接口封装
```javascript
// userApi.js - 用户相关接口
import api from './api';

export const userApi = {
  // 用户认证
  register: (userData) => api.post('/user/register', userData),
  login: (loginData) => api.post('/user/login', loginData),
  logout: () => api.post('/user/logout'),
  getCurrentUser: () => api.get('/user/get/login'),

  // 密钥管理
  getUserKeys: () => api.get('/user/get/keys'),
  generateKeys: () => api.post('/user/generate/keys'),
  regenerateKeys: () => api.post('/user/regenerate/keys'),
};

// interfaceApi.js - 接口管理相关
export const interfaceApi = {
  // 接口管理
  getInterfaceList: (params) => api.post('/api/interfaceInfo/list/page/vo', params),
  getInterfaceDetail: (id) => api.get('/api/interfaceInfo/get/vo', { id }),
  createInterface: (data) => api.post('/api/interfaceInfo/add', data),
  updateInterface: (data) => api.post('/api/interfaceInfo/update', data),
  deleteInterface: (id) => api.post('/api/interfaceInfo/delete', { id }),
  
  // 接口状态管理
  onlineInterface: (id) => api.post('/api/interfaceInfo/online', { id }),
  offlineInterface: (id) => api.post('/api/interfaceInfo/offline', { id }),
  
  // 接口调试
  invokeInterface: (id, params) => api.post('/interfaceInfo/invoke', {
    id,
    userRequestParams: JSON.stringify(params)
  }),
  getAvailableApis: () => api.get('/interfaceInfo/available-apis'),
};

// analysisApi.js - 数据分析相关
export const analysisApi = {
  getTopInvokeInterfaces: () => api.get('/api/analysis/top/interface/invoke'),
};
```

### 3. React Hook 封装示例
```javascript
// hooks/useApi.js
import { useState, useEffect } from 'react';
import { interfaceApi } from '../api/interfaceApi';

// 接口列表Hook
export const useInterfaceList = (params) => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [total, setTotal] = useState(0);

  const fetchData = async () => {
    setLoading(true);
    try {
      const result = await interfaceApi.getInterfaceList(params);
      setData(result.records || []);
      setTotal(result.total || 0);
    } catch (error) {
      console.error('获取接口列表失败:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [JSON.stringify(params)]);

  return { data, loading, total, refresh: fetchData };
};

// 接口调试Hook
export const useInterfaceInvoke = () => {
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);

  const invoke = async (interfaceId, params) => {
    setLoading(true);
    try {
      const response = await interfaceApi.invokeInterface(interfaceId, params);
      setResult(response);
      return response;
    } catch (error) {
      console.error('接口调用失败:', error);
      throw error;
    } finally {
      setLoading(false);
    }
  };

  return { invoke, loading, result };
};
```

### 4. Vue Composition API 封装示例
```javascript
// composables/useApi.js
import { ref, reactive } from 'vue';
import { interfaceApi } from '../api/interfaceApi';

// 接口列表组合式函数
export function useInterfaceList() {
  const list = ref([]);
  const loading = ref(false);
  const pagination = reactive({
    current: 1,
    pageSize: 10,
    total: 0
  });

  const fetchList = async (params = {}) => {
    loading.value = true;
    try {
      const result = await interfaceApi.getInterfaceList({
        current: pagination.current,
        pageSize: pagination.pageSize,
        ...params
      });
      list.value = result.records || [];
      pagination.total = result.total || 0;
    } catch (error) {
      console.error('获取接口列表失败:', error);
    } finally {
      loading.value = false;
    }
  };

  return {
    list,
    loading,
    pagination,
    fetchList
  };
}

// 接口调试组合式函数
export function useInterfaceInvoke() {
  const loading = ref(false);
  const result = ref(null);

  const invoke = async (interfaceId, params) => {
    loading.value = true;
    try {
      const response = await interfaceApi.invokeInterface(interfaceId, params);
      result.value = response;
      return response;
    } catch (error) {
      console.error('接口调用失败:', error);
      throw error;
    } finally {
      loading.value = false;
    }
  };

  return {
    invoke,
    loading,
    result
  };
}
```

---

## 🔧 调试和测试

### 1. 浏览器开发者工具验证
```javascript
// 控制台测试登录状态
fetch('/user/get/login', { credentials: 'include' })
  .then(res => res.json())
  .then(data => console.log('当前用户:', data));

// 控制台测试接口列表
fetch('/api/interfaceInfo/list/page/vo', {
  method: 'POST',
  credentials: 'include',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ current: 1, pageSize: 5 })
}).then(res => res.json()).then(data => console.log('接口列表:', data));
```

### 2. 错误处理验证
```javascript
// 测试未登录状态
fetch('/api/interfaceInfo/list/page/vo', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  // 不携带credentials
  body: JSON.stringify({ current: 1, pageSize: 5 })
}).then(res => res.json()).then(data => {
  console.log('应该返回未登录错误:', data);
});
```

---

## 📝 迁移检查清单

### ✅ 前端代码检查
- [ ] 确保所有API请求都设置了 `credentials: 'include'`
- [ ] 登录接口正确保存Session Cookie
- [ ] 错误处理包含40101（未登录）的跳转逻辑
- [ ] 接口调试功能使用 `/interfaceInfo/invoke` 路径
- [ ] 分页查询等业务接口使用 `/api/**` 路径

### ✅ 功能测试
- [ ] 用户注册登录流程正常
- [ ] 登录后可以正常访问业务接口
- [ ] 接口调试功能无需手动输入密钥
- [ ] 分页查询等功能正常工作
- [ ] 登出后无法访问需要认证的接口

### ✅ 性能检查
- [ ] Session认证响应速度正常
- [ ] 接口调试响应时间可接受
- [ ] 大量请求时Session管理正常

---

## 🎯 总结

1. **主要优势**:
   - 大部分接口路径无需修改
   - 用户体验大幅提升（无需手动管理密钥）
   - 认证流程简化
   - 代码维护性更好

2. **核心变化**:
   - 所有请求必须携带 `credentials: 'include'`
   - 接口调试自动使用用户密钥
   - 统一的Session认证机制

3. **开发建议**:
   - 使用统一的API客户端封装
   - 实现自动的错误处理和跳转
   - 添加Loading状态管理
   - 做好接口调用的缓存优化

现在前端开发将更加简单和用户友好！🚀