# åŒé‡è®¤è¯æœºåˆ¶è¯´æ˜

## ğŸ¯ éœ€æ±‚æ¦‚è¿°

ç³»ç»Ÿç°åœ¨æ”¯æŒä¸¤ç§ä¸åŒçš„APIè°ƒç”¨è®¤è¯æ–¹å¼ï¼š

1. **å¹³å°å†…è°ƒè¯•**ï¼šé€šè¿‡å‰ç«¯ç™»å½•åè°ƒç”¨ï¼ŒåŸºäºSessionè®¤è¯ï¼Œè‡ªåŠ¨ä½¿ç”¨ç™»å½•ç”¨æˆ·çš„å¯†é’¥
2. **ç¬¬ä¸‰æ–¹è°ƒç”¨**ï¼šå¤–éƒ¨å¼€å‘è€…è°ƒç”¨ï¼ŒåŸºäºè¯·æ±‚å¤´å¯†é’¥è®¤è¯

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç½‘å…³å±‚å®ç° (CustomGlobalFilter)

#### ğŸ” è·¯å¾„åˆ†ç±»
```java
// ç™½åå•è·¯å¾„ - å®Œå…¨è·³è¿‡è®¤è¯
private static final List<String> PATH_WHITE_LIST = Arrays.asList(
    "/user/register",    // ç”¨æˆ·æ³¨å†Œ
    "/user/login",       // ç”¨æˆ·ç™»å½•
    "/user/login/wx_open", // å¾®ä¿¡ç™»å½•
    "/user/logout"       // ç”¨æˆ·ç™»å‡º
);

// å¹³å°å†…éƒ¨è°ƒè¯•è·¯å¾„ - åŸºäºSessionè®¤è¯
private static final List<String> INTERNAL_DEBUG_PATHS = Arrays.asList(
    "/interfaceInfo/invoke"  // æ¥å£è°ƒç”¨
);
```

#### ğŸ›¡ï¸ è®¤è¯æµç¨‹
```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    String requestPath = request.getPath().value();
    
    // 1. æ£€æŸ¥ç™½åå•è·¯å¾„
    if (isWhiteListPath(requestPath)) {
        return chain.filter(exchange);  // ç›´æ¥æ”¾è¡Œ
    }
    
    // 2. æ£€æŸ¥å¹³å°å†…éƒ¨è°ƒè¯•è·¯å¾„
    if (isInternalDebugPath(requestPath)) {
        return handleInternalDebug(exchange, chain, request, response);
    }
    
    // 3. ç¬¬ä¸‰æ–¹è°ƒç”¨ - æ‰§è¡Œå®Œæ•´çš„å¯†é’¥è®¤è¯æµç¨‹
    // ... åŸæœ‰çš„ accessKey/secretKey è®¤è¯é€»è¾‘
}
```

#### ğŸ“ Sessionè®¤è¯å¤„ç†
```java
private Mono<Void> handleInternalDebug(ServerWebExchange exchange, GatewayFilterChain chain, 
                                       ServerHttpRequest request, ServerHttpResponse response) {
    // è·å–Sessionä¿¡æ¯ï¼ˆä»Cookieä¸­è·å–ï¼‰
    String sessionId = getSessionFromCookie(request);
    if (sessionId == null) {
        return handleNoAuth(response);  // æ— Sessionç›´æ¥æ‹’ç»
    }
    
    // ç›´æ¥æ”¾è¡Œï¼Œç”±åç«¯æœåŠ¡å¤„ç†å…·ä½“çš„ç”¨æˆ·è®¤è¯
    return chain.filter(exchange);
}
```

### 2. åç«¯æœåŠ¡å®ç° (InterfaceInfoController)

#### ğŸ”‘ å¹³å°å†…è°ƒè¯•è®¤è¯
```java
@PostMapping("/invoke")
public BaseResponse<Object> invokeInterfaceInfo(@RequestBody InterfaceInfoInvokeRequest request, 
                                               HttpServletRequest httpRequest) {
    // è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆåŸºäºSessionï¼‰
    User loginUser = userService.getLoginUser(httpRequest);
    
    // è‡ªåŠ¨ä½¿ç”¨ç™»å½•ç”¨æˆ·çš„å¯†é’¥
    String accessKey = loginUser.getAccessKey();
    String secretKey = loginUser.getSecretKey();
    
    // è°ƒç”¨API
    Object result = invokeApiByInterfaceInfo(interfaceInfo, userRequestParams, accessKey, secretKey);
    return ResultUtils.success(result);
}
```

## ğŸ”„ è°ƒç”¨æµç¨‹å¯¹æ¯”

### å¹³å°å†…è°ƒè¯•æµç¨‹
```mermaid
graph TD
    A[å‰ç«¯ç”¨æˆ·] --> B[ç™»å½•è·å–Session]
    B --> C[è°ƒç”¨ /interfaceInfo/invoke]
    C --> D[ç½‘å…³æ£€æŸ¥è·¯å¾„]
    D --> E[è¯†åˆ«ä¸ºå†…éƒ¨è°ƒè¯•è·¯å¾„]
    E --> F[æ£€æŸ¥Cookieä¸­çš„Session]
    F --> G[Sessionå­˜åœ¨ï¼Œæ”¾è¡Œåˆ°åç«¯]
    G --> H[åç«¯é€šè¿‡Sessionè·å–ç”¨æˆ·]
    H --> I[ä½¿ç”¨ç”¨æˆ·çš„accessKey/secretKey]
    I --> J[è°ƒç”¨ç¬¬ä¸‰æ–¹API]
    J --> K[è¿”å›ç»“æœ]
```

### ç¬¬ä¸‰æ–¹è°ƒç”¨æµç¨‹
```mermaid
graph TD
    A[ç¬¬ä¸‰æ–¹å¼€å‘è€…] --> B[åœ¨è¯·æ±‚å¤´æºå¸¦å¯†é’¥]
    B --> C[è°ƒç”¨ /api/xxx]
    C --> D[ç½‘å…³æ£€æŸ¥è·¯å¾„]
    D --> E[è¯†åˆ«ä¸ºç¬¬ä¸‰æ–¹è°ƒç”¨]
    E --> F[éªŒè¯è¯·æ±‚å¤´ä¸­çš„accessKey]
    F --> G[éªŒè¯ç­¾å]
    G --> H[æ£€æŸ¥è°ƒç”¨æ¬¡æ•°]
    H --> I[æ”¾è¡Œåˆ°æ¥å£æœåŠ¡]
    I --> J[è¿”å›ç»“æœ]
```

## ğŸ“‹ è¯·æ±‚ç¤ºä¾‹

### 1. å¹³å°å†…è°ƒè¯•è¯·æ±‚
```bash
# å‰ç«¯é€šè¿‡Sessionè°ƒç”¨
curl -X POST http://localhost:8090/interfaceInfo/invoke \
  -H "Content-Type: application/json" \
  -H "Cookie: SESSION=your-session-id" \
  -d '{
    "id": 1,
    "userRequestParams": "{\"name\":\"æµ‹è¯•\"}"
  }'
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä¸éœ€è¦åœ¨è¯·æ±‚å¤´æºå¸¦å¯†é’¥
- âœ… åŸºäºCookieçš„Sessionè®¤è¯
- âœ… è‡ªåŠ¨ä½¿ç”¨ç™»å½•ç”¨æˆ·çš„å¯†é’¥
- âœ… ç”¨æˆ·ä½“éªŒå‹å¥½

### 2. ç¬¬ä¸‰æ–¹è°ƒç”¨è¯·æ±‚
```bash
# ç¬¬ä¸‰æ–¹å¼€å‘è€…è°ƒç”¨
curl -X GET http://localhost:8090/api/name \
  -H "accessKey: qiapi_1703123456789_abc12def" \
  -H "secretKey: your-secret-key" \
  -H "nonce: 12345" \
  -H "timestamp: 1703123456" \
  -H "sign: calculated-signature" \
  -H "body: {}"
```

**ç‰¹ç‚¹**ï¼š
- âœ… éœ€è¦å®Œæ•´çš„ç­¾åè®¤è¯
- âœ… æ”¯æŒè°ƒç”¨æ¬¡æ•°ç»Ÿè®¡
- âœ… æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»
- âœ… å®‰å…¨æ€§æ›´é«˜

## ğŸ› ï¸ é…ç½®è¯´æ˜

### ç½‘å…³è·¯ç”±é…ç½®
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user_route
          uri: http://localhost:7529
          predicates:
            - Path=/user/**
        - id: interface_route  
          uri: http://localhost:7529
          predicates:
            - Path=/interfaceInfo/**
        - id: api_route
          uri: http://localhost:8101
          predicates:
            - Path=/api/**
```

### è®¤è¯è·¯å¾„é…ç½®
- **ç™½åå•è·¯å¾„**ï¼š`/user/register`, `/user/login`, `/user/logout` ç­‰
- **å†…éƒ¨è°ƒè¯•è·¯å¾„**ï¼š`/interfaceInfo/invoke`
- **ç¬¬ä¸‰æ–¹APIè·¯å¾„**ï¼š`/api/**`

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æ—¥å¿—è¾“å‡º
```
# å¹³å°å†…è°ƒè¯•
INFO: å¹³å°å†…éƒ¨è°ƒè¯•è·¯å¾„ï¼Œä½¿ç”¨Sessionè®¤è¯ï¼š/interfaceInfo/invoke
INFO: å¹³å°å†…éƒ¨è°ƒè¯•è¯·æ±‚ï¼Œç›´æ¥æ”¾è¡Œç”±åç«¯æœåŠ¡å¤„ç†

# ç¬¬ä¸‰æ–¹è°ƒç”¨
INFO: è¯·æ±‚è·¯å¾„ï¼šhttp://localhost:8101/api/name
INFO: å¼€å§‹æ‰§è¡Œç”¨æˆ·é‰´æƒæµç¨‹
INFO: ç­¾åéªŒè¯é€šè¿‡ï¼Œç”¨æˆ·ï¼šxxx
```

### å‰ç«¯é›†æˆå»ºè®®
```javascript
// å¹³å°å†…è°ƒè¯• - è‡ªåŠ¨æºå¸¦Session
const invokeApi = async (apiId, params) => {
  const response = await fetch('/interfaceInfo/invoke', {
    method: 'POST',
    credentials: 'include',  // è‡ªåŠ¨æºå¸¦Cookie
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      id: apiId,
      userRequestParams: JSON.stringify(params)
    })
  });
  return response.json();
};
```

## âœ… å®ç°ä¼˜åŠ¿

1. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - å¹³å°å†…è°ƒè¯•æ— éœ€æ‰‹åŠ¨è¾“å…¥å¯†é’¥
   - è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·çš„å‡­è¯
   - ç®€åŒ–è°ƒè¯•æµç¨‹

2. **å®‰å…¨æ€§ä¿éšœ**
   - Sessionå’Œå¯†é’¥åŒé‡è®¤è¯æœºåˆ¶
   - ç¬¬ä¸‰æ–¹è°ƒç”¨ä»ä¿æŒä¸¥æ ¼éªŒè¯
   - è°ƒç”¨æ¥æºå¯è¿½æº¯

3. **åŠŸèƒ½å®Œæ•´æ€§**
   - æ”¯æŒå¹³å°å†…å¤–ä¸¤ç§è°ƒç”¨æ–¹å¼
   - ä¿æŒåŸæœ‰çš„ç»Ÿè®¡å’Œç›‘æ§åŠŸèƒ½
   - å‘åå…¼å®¹ç°æœ‰çš„ç¬¬ä¸‰æ–¹é›†æˆ

4. **æ¶æ„æ¸…æ™°**
   - ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†è®¤è¯é€»è¾‘
   - åç«¯æœåŠ¡ä¸“æ³¨ä¸šåŠ¡å®ç°
   - èŒè´£åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤

ç°åœ¨ä½ çš„ç³»ç»Ÿå®Œç¾æ”¯æŒäº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼Œç”¨æˆ·åœ¨å¹³å°å†…è°ƒè¯•æ—¶ä½“éªŒæ›´åŠ å‹å¥½ï¼