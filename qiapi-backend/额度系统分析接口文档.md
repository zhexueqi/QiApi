# 额度系统分析接口文档

## 概述
本文档描述了基于额度系统的多维度统计分析接口，提供传统调用次数统计和新的额度系统统计功能。

## 接口列表

### 1. 传统调用次数统计

#### 1.1 获取接口调用次数排行榜
- **URL**: `GET /analysis/top/interface/invoke`
- **描述**: 获取调用次数最多的接口排行榜
- **权限**: 管理员
- **参数**: 无
- **返回示例**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "获取用户名",
      "description": "根据输入的用户名返回用户信息",
      "url": "http://localhost:8081/api/name",
      "totalNum": 150
    }
  ],
  "message": "ok"
}
```

### 2. 额度系统统计

#### 2.1 获取接口额度消费排行榜
- **URL**: `GET /analysis/credit/top/interfaces`
- **描述**: 获取额度消费最多的接口排行榜
- **权限**: 管理员
- **参数**: 
  - `limit` (可选): 返回数量限制，默认10
- **返回示例**:
```json
{
  "code": 0,
  "data": [
    {
      "interfaceId": 1,
      "interfaceName": "获取用户名",
      "totalCreditConsumed": 5000,
      "totalRemainingCredit": 2000,
      "userCount": 50,
      "avgCreditPerUser": 100.0
    }
  ],
  "message": "ok"
}
```

#### 2.2 获取用户额度消费排行榜
- **URL**: `GET /analysis/credit/top/users`
- **描述**: 获取额度消费最多的用户排行榜
- **权限**: 管理员
- **参数**:
  - `limit` (可选): 返回数量限制，默认10
- **返回示例**:
```json
{
  "code": 0,
  "data": [
    {
      "userId": 1,
      "userName": "zhexueqi",
      "totalConsumedCredit": 1000,
      "totalRemainingCredit": 500,
      "activeInterfaceCount": 5,
      "avgCreditPerInterface": 200.0
    }
  ],
  "message": "ok"
}
```

#### 2.3 获取所有接口的额度统计
- **URL**: `GET /analysis/credit/interfaces/all`
- **描述**: 获取所有接口的额度统计信息
- **权限**: 管理员
- **参数**: 无
- **返回**: 同2.1，但包含所有接口

#### 2.4 获取低额度用户列表
- **URL**: `GET /analysis/credit/users/low`
- **描述**: 获取剩余额度较低的用户列表
- **权限**: 管理员
- **参数**:
  - `threshold` (可选): 剩余额度阈值，默认100
  - `limit` (可选): 返回数量限制，默认20
- **返回示例**:
```json
{
  "code": 0,
  "data": [
    {
      "userId": 2,
      "userName": "testuser",
      "totalConsumedCredit": 900,
      "totalRemainingCredit": 50,
      "activeInterfaceCount": 3,
      "avgCreditPerInterface": 300.0
    }
  ],
  "message": "ok"
}
```

### 3. 趋势分析

#### 3.1 获取最近N天的额度操作趋势
- **URL**: `GET /analysis/credit/trend/recent`
- **描述**: 获取最近N天的额度操作趋势统计
- **权限**: 管理员
- **参数**:
  - `days` (可选): 天数，默认7，范围1-90
- **返回示例**:
```json
{
  "code": 0,
  "data": [
    {
      "date": "2024-01-01",
      "dailyConsumed": 1000,
      "dailyRecharged": 500,
      "activeUsers": 25,
      "newUsers": 3,
      "operationDistribution": "{\"CONSUME\":100,\"RECHARGE\":20,\"TRANSFER\":5,\"REFUND\":2}"
    }
  ],
  "message": "ok"
}
```

#### 3.2 获取指定日期范围的额度操作趋势
- **URL**: `GET /analysis/credit/trend/daterange`
- **描述**: 获取指定日期范围内的额度操作趋势
- **权限**: 管理员
- **参数**:
  - `startDate`: 开始日期，格式: yyyy-MM-dd
  - `endDate`: 结束日期，格式: yyyy-MM-dd
  - 日期范围不能超过365天
- **返回**: 同3.1

## 功能特点

### 1. 多维度统计
- **接口维度**: 按接口统计额度消费情况
- **用户维度**: 按用户统计额度使用情况
- **时间维度**: 按日期统计额度操作趋势
- **操作维度**: 按操作类型统计（消费、充值、转移、退款）

### 2. 实用功能
- **排行榜**: 支持TOP N查询
- **低额度预警**: 识别剩余额度不足的用户
- **趋势分析**: 了解平台使用趋势
- **操作分布**: 了解各种操作的频率分布

### 3. 数据安全
- **权限控制**: 所有接口需要管理员权限
- **参数验证**: 严格的输入参数验证
- **异常处理**: 完善的错误处理机制
- **日志记录**: 详细的操作日志

## 注意事项

1. **权限要求**: 所有统计接口都需要管理员权限（`@AuthCheck(mustRole = "admin")`）
2. **性能考虑**: 
   - 大数据量查询可能较慢，建议合理设置limit参数
   - 日期范围查询限制在365天内
3. **数据一致性**: 统计数据基于实时数据库查询，确保数据准确性
4. **兼容性**: 保留原有的调用次数统计，支持平滑迁移

## 使用建议

1. **监控面板**: 可基于这些接口构建管理后台的数据监控面板
2. **定期分析**: 建议定期查看趋势数据，了解平台使用情况
3. **用户运营**: 利用低额度用户列表进行精准营销
4. **容量规划**: 基于消费趋势进行系统容量规划
