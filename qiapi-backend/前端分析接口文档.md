# QiAPI开放平台 - 前端分析接口文档

## 基础信息

- **基础URL**: `http://localhost:8090`
- **接口前缀**: `/analysis`
- **认证方式**: Session认证（需要管理员权限）
- **响应格式**: JSON
- **字符编码**: UTF-8

## 响应格式说明

### 统一响应结构
```typescript
interface BaseResponse<T> {
  code: number;        // 响应码，0表示成功
  data: T;            // 响应数据
  message: string;    // 响应消息
}
```

### 错误码说明
- `0`: 成功
- `40000`: 请求参数错误
- `40100`: 未登录
- `40101`: 无权限
- `50000`: 系统内部异常

## 数据模型

### InterfaceInfoVO
```typescript
interface InterfaceInfoVO {
  id: number;                 // 接口ID
  name: string;              // 接口名称
  description: string;       // 接口描述
  url: string;               // 接口地址
  requestParams: string;     // 请求参数
  requestHeader: string;     // 请求头
  responseHeader: string;    // 响应头
  status: number;            // 接口状态 0-关闭 1-开启
  method: string;            // 请求类型
  userId: number;            // 创建人ID
  createTime: string;        // 创建时间
  updateTime: string;        // 更新时间
  totalNum: number;          // 总调用次数
}
```

### CreditAnalysisVO
```typescript
interface CreditAnalysisVO {
  interfaceId: number;           // 接口ID
  interfaceName: string;         // 接口名称
  totalCreditConsumed: number;   // 总额度消费量
  totalRemainingCredit: number;  // 总剩余额度
  userCount: number;             // 用户数量
  avgCreditPerUser: number;      // 平均每用户消费额度
}
```

### UserCreditStatsVO
```typescript
interface UserCreditStatsVO {
  userId: number;                 // 用户ID
  userName: string;               // 用户名
  totalConsumedCredit: number;    // 总消费额度
  totalRemainingCredit: number;   // 总剩余额度
  activeInterfaceCount: number;   // 活跃接口数量
  avgCreditPerInterface: number;  // 平均每接口消费额度
}
```

### CreditTrendVO
```typescript
interface CreditTrendVO {
  date: string;                   // 日期（YYYY-MM-DD格式）
  dailyConsumed: number;          // 当日总消费额度
  dailyRecharged: number;         // 当日充值额度
  activeUsers: number;            // 当日活跃用户数
  newUsers: number;               // 当日新增用户数
  operationDistribution: string;  // 操作类型分布（JSON字符串）
}
```

## 接口列表

### 1. 传统调用次数统计

#### 1.1 获取接口调用次数排行榜

**接口信息**
- **URL**: `GET /analysis/top/interface/invoke`
- **功能**: 获取调用次数最多的接口排行榜（TOP 3）
- **权限**: 管理员

**请求示例**
```javascript
// 使用fetch
fetch('http://localhost:8090/analysis/top/interface/invoke', {
  method: 'GET',
  credentials: 'include', // 包含session cookie
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(response => response.json())
.then(data => {
  console.log('接口调用排行榜:', data);
});

// 使用axios
axios.get('/analysis/top/interface/invoke', {
  withCredentials: true
})
.then(response => {
  console.log('接口调用排行榜:', response.data);
});
```

**响应示例**
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "获取用户名",
      "description": "根据输入的用户名返回用户信息",
      "url": "http://localhost:8081/api/name",
      "requestParams": "[{\"name\":\"username\",\"type\":\"string\"}]",
      "requestHeader": "Content-Type: application/json",
      "responseHeader": "Content-Type: application/json",
      "status": 1,
      "method": "GET",
      "userId": 1,
      "createTime": "2024-01-01 12:00:00",
      "updateTime": "2024-01-01 12:00:00",
      "totalNum": 150
    }
  ],
  "message": "ok"
}
```

### 2. 额度系统统计

#### 2.1 获取接口额度消费排行榜

**接口信息**
- **URL**: `GET /analysis/credit/top/interfaces`
- **功能**: 获取额度消费最多的接口排行榜
- **权限**: 管理员

**请求参数**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| limit  | number | 否 | 10 | 返回数量限制 |

**请求示例**
```javascript
// 获取TOP 10
fetch('http://localhost:8090/analysis/credit/top/interfaces?limit=10', {
  method: 'GET',
  credentials: 'include',
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(response => response.json())
.then(data => {
  console.log('接口额度消费排行榜:', data);
});

// 使用URLSearchParams构建查询参数
const params = new URLSearchParams({
  limit: '5'
});
fetch(`http://localhost:8090/analysis/credit/top/interfaces?${params}`, {
  method: 'GET',
  credentials: 'include'
})
.then(response => response.json())
.then(data => {
  console.log('TOP 5接口:', data);
});
```

**响应示例**
```json
{
  "code": 0,
  "data": [
    {
      "interfaceId": 1,
      "interfaceName": "获取用户名",
      "totalCreditConsumed": 5000,
      "totalRemainingCredit": 2000,
      "userCount": 50,
      "avgCreditPerUser": 100.0
    },
    {
      "interfaceId": 2,
      "interfaceName": "随机头像",
      "totalCreditConsumed": 3000,
      "totalRemainingCredit": 1500,
      "userCount": 30,
      "avgCreditPerUser": 100.0
    }
  ],
  "message": "ok"
}
```

#### 2.2 获取用户额度消费排行榜

**接口信息**
- **URL**: `GET /analysis/credit/top/users`
- **功能**: 获取额度消费最多的用户排行榜
- **权限**: 管理员

**请求参数**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| limit  | number | 否 | 10 | 返回数量限制 |

**请求示例**
```javascript
// Vue.js组件中使用
export default {
  data() {
    return {
      topUsers: [],
      loading: false
    }
  },
  methods: {
    async fetchTopUsers(limit = 10) {
      this.loading = true;
      try {
        const response = await axios.get('/analysis/credit/top/users', {
          params: { limit },
          withCredentials: true
        });
        this.topUsers = response.data.data;
      } catch (error) {
        console.error('获取用户排行榜失败:', error);
        this.$message.error('获取数据失败');
      } finally {
        this.loading = false;
      }
    }
  }
}
```

**响应示例**
```json
{
  "code": 0,
  "data": [
    {
      "userId": 1,
      "userName": "zhexueqi",
      "totalConsumedCredit": 1000,
      "totalRemainingCredit": 500,
      "activeInterfaceCount": 5,
      "avgCreditPerInterface": 200.0
    },
    {
      "userId": 2,
      "userName": "testuser",
      "totalConsumedCredit": 800,
      "totalRemainingCredit": 300,
      "activeInterfaceCount": 3,
      "avgCreditPerInterface": 266.67
    }
  ],
  "message": "ok"
}
```

#### 2.3 获取所有接口的额度统计

**接口信息**
- **URL**: `GET /analysis/credit/interfaces/all`
- **功能**: 获取所有接口的额度统计信息
- **权限**: 管理员

**请求示例**
```javascript
// React Hook示例
import { useState, useEffect } from 'react';

function useAllInterfaceStats() {
  const [stats, setStats] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchStats = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch('http://localhost:8090/analysis/credit/interfaces/all', {
        credentials: 'include'
      });
      const data = await response.json();
      
      if (data.code === 0) {
        setStats(data.data);
      } else {
        setError(data.message);
      }
    } catch (err) {
      setError('获取数据失败');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchStats();
  }, []);

  return { stats, loading, error, refetch: fetchStats };
}
```

#### 2.4 获取低额度用户列表

**接口信息**
- **URL**: `GET /analysis/credit/users/low`
- **功能**: 获取剩余额度较低的用户列表（用于预警）
- **权限**: 管理员

**请求参数**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| threshold | number | 否 | 100 | 剩余额度阈值 |
| limit | number | 否 | 20 | 返回数量限制 |

**请求示例**
```javascript
// 获取剩余额度低于50的用户，最多返回15个
const getLowCreditUsers = async (threshold = 50, limit = 15) => {
  try {
    const params = new URLSearchParams({
      threshold: threshold.toString(),
      limit: limit.toString()
    });
    
    const response = await fetch(`http://localhost:8090/analysis/credit/users/low?${params}`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.code === 0) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取低额度用户失败:', error);
    throw error;
  }
};
```

**响应示例**
```json
{
  "code": 0,
  "data": [
    {
      "userId": 3,
      "userName": "lowcredituser",
      "totalConsumedCredit": 950,
      "totalRemainingCredit": 50,
      "activeInterfaceCount": 2,
      "avgCreditPerInterface": 475.0
    }
  ],
  "message": "ok"
}
```

### 3. 趋势分析

#### 3.1 获取最近N天的额度操作趋势

**接口信息**
- **URL**: `GET /analysis/credit/trend/recent`
- **功能**: 获取最近N天的额度操作趋势统计
- **权限**: 管理员

**请求参数**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| days | number | 否 | 7 | 天数，范围1-90 |

**请求示例**
```javascript
// TypeScript示例
interface TrendApiResponse {
  code: number;
  data: CreditTrendVO[];
  message: string;
}

class AnalyticsService {
  private baseUrl = 'http://localhost:8090';

  async getRecentTrend(days: number = 7): Promise<CreditTrendVO[]> {
    if (days < 1 || days > 90) {
      throw new Error('天数范围应在1-90之间');
    }

    const response = await fetch(`${this.baseUrl}/analysis/credit/trend/recent?days=${days}`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const result: TrendApiResponse = await response.json();
    
    if (result.code !== 0) {
      throw new Error(result.message);
    }

    return result.data;
  }
}

// 使用示例
const analyticsService = new AnalyticsService();
analyticsService.getRecentTrend(14)
  .then(trends => {
    console.log('最近14天趋势:', trends);
    // 处理趋势数据，如绘制图表
  })
  .catch(error => {
    console.error('获取趋势数据失败:', error);
  });
```

**响应示例**
```json
{
  "code": 0,
  "data": [
    {
      "date": "2024-01-07",
      "dailyConsumed": 1200,
      "dailyRecharged": 500,
      "activeUsers": 28,
      "newUsers": 3,
      "operationDistribution": "{\"CONSUME\":120,\"RECHARGE\":25,\"TRANSFER\":5,\"REFUND\":2}"
    },
    {
      "date": "2024-01-06",
      "dailyConsumed": 1000,
      "dailyRecharged": 300,
      "activeUsers": 25,
      "newUsers": 2,
      "operationDistribution": "{\"CONSUME\":100,\"RECHARGE\":15,\"TRANSFER\":3,\"REFUND\":1}"
    }
  ],
  "message": "ok"
}
```

#### 3.2 获取指定日期范围的额度操作趋势

**接口信息**
- **URL**: `GET /analysis/credit/trend/daterange`
- **功能**: 获取指定日期范围内的额度操作趋势
- **权限**: 管理员

**请求参数**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| startDate | string | 是 | - | 开始日期，格式: yyyy-MM-dd |
| endDate | string | 是 | - | 结束日期，格式: yyyy-MM-dd |

**注意事项**
- 日期范围不能超过365天
- 开始日期不能晚于结束日期

**请求示例**
```javascript
// 日期范围查询组件示例
class DateRangeTrendComponent {
  constructor() {
    this.startDate = '';
    this.endDate = '';
    this.trendData = [];
    this.loading = false;
  }

  async fetchTrendByDateRange() {
    if (!this.startDate || !this.endDate) {
      alert('请选择开始日期和结束日期');
      return;
    }

    // 验证日期范围
    const start = new Date(this.startDate);
    const end = new Date(this.endDate);
    const diffTime = Math.abs(end.getTime() - start.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays > 365) {
      alert('查询范围不能超过365天');
      return;
    }

    this.loading = true;
    try {
      const params = new URLSearchParams({
        startDate: this.startDate,
        endDate: this.endDate
      });

      const response = await fetch(`http://localhost:8090/analysis/credit/trend/daterange?${params}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();
      
      if (result.code === 0) {
        this.trendData = result.data;
        this.renderChart(this.trendData);
      } else {
        alert(`获取数据失败: ${result.message}`);
      }
    } catch (error) {
      console.error('请求失败:', error);
      alert('网络请求失败');
    } finally {
      this.loading = false;
    }
  }

  renderChart(data) {
    // 使用echarts或其他图表库渲染趋势图
    const dates = data.map(item => item.date);
    const consumed = data.map(item => item.dailyConsumed);
    const recharged = data.map(item => item.dailyRecharged);
    
    // 图表配置和渲染逻辑
    console.log('图表数据:', { dates, consumed, recharged });
  }
}

// Vue.js组件使用示例
export default {
  data() {
    return {
      dateRange: [],
      trendData: [],
      loading: false
    }
  },
  methods: {
    async onDateRangeChange(dates) {
      if (dates && dates.length === 2) {
        const [startDate, endDate] = dates;
        await this.fetchTrendData(
          startDate.format('YYYY-MM-DD'),
          endDate.format('YYYY-MM-DD')
        );
      }
    },
    
    async fetchTrendData(startDate, endDate) {
      this.loading = true;
      try {
        const { data } = await this.$http.get('/analysis/credit/trend/daterange', {
          params: { startDate, endDate }
        });
        this.trendData = data.data;
      } catch (error) {
        this.$message.error('获取趋势数据失败');
      } finally {
        this.loading = false;
      }
    }
  }
}
```

## 前端开发建议

### 1. 状态管理
```javascript
// Vuex store示例
const analyticsModule = {
  namespaced: true,
  state: {
    interfaceRanking: [],
    userRanking: [],
    allInterfaceStats: [],
    lowCreditUsers: [],
    trendData: [],
    loading: false,
    error: null
  },
  
  mutations: {
    SET_LOADING(state, loading) {
      state.loading = loading;
    },
    SET_ERROR(state, error) {
      state.error = error;
    },
    SET_INTERFACE_RANKING(state, data) {
      state.interfaceRanking = data;
    },
    SET_USER_RANKING(state, data) {
      state.userRanking = data;
    },
    SET_ALL_INTERFACE_STATS(state, data) {
      state.allInterfaceStats = data;
    },
    SET_LOW_CREDIT_USERS(state, data) {
      state.lowCreditUsers = data;
    },
    SET_TREND_DATA(state, data) {
      state.trendData = data;
    }
  },
  
  actions: {
    async fetchInterfaceRanking({ commit }, limit = 10) {
      commit('SET_LOADING', true);
      try {
        const response = await api.get('/analysis/credit/top/interfaces', { params: { limit } });
        commit('SET_INTERFACE_RANKING', response.data.data);
      } catch (error) {
        commit('SET_ERROR', error.message);
      } finally {
        commit('SET_LOADING', false);
      }
    }
  }
};
```

### 2. 错误处理
```javascript
// 统一错误处理
class ApiClient {
  constructor(baseURL) {
    this.baseURL = baseURL;
  }

  async request(url, options = {}) {
    const config = {
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    };

    try {
      const response = await fetch(`${this.baseURL}${url}`, config);
      const data = await response.json();

      if (data.code !== 0) {
        throw new Error(data.message || '请求失败');
      }

      return data.data;
    } catch (error) {
      console.error(`API请求失败 [${url}]:`, error);
      
      // 根据错误类型进行不同处理
      if (error.message.includes('40101')) {
        // 权限不足，跳转到登录页
        window.location.href = '/login';
      }
      
      throw error;
    }
  }

  // 封装各个接口
  getTopInterfaces(limit) {
    return this.request(`/analysis/credit/top/interfaces?limit=${limit}`);
  }

  getTopUsers(limit) {
    return this.request(`/analysis/credit/top/users?limit=${limit}`);
  }

  getAllInterfaceStats() {
    return this.request('/analysis/credit/interfaces/all');
  }

  getLowCreditUsers(threshold, limit) {
    return this.request(`/analysis/credit/users/low?threshold=${threshold}&limit=${limit}`);
  }

  getRecentTrend(days) {
    return this.request(`/analysis/credit/trend/recent?days=${days}`);
  }

  getTrendByDateRange(startDate, endDate) {
    return this.request(`/analysis/credit/trend/daterange?startDate=${startDate}&endDate=${endDate}`);
  }
}

// 创建API客户端实例
const apiClient = new ApiClient('http://localhost:8090');
```

### 3. 数据可视化示例
```javascript
// 使用ECharts绘制趋势图
function renderTrendChart(data) {
  const option = {
    title: {
      text: '额度使用趋势'
    },
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['消费额度', '充值额度', '活跃用户']
    },
    xAxis: {
      type: 'category',
      data: data.map(item => item.date)
    },
    yAxis: [
      {
        type: 'value',
        name: '额度',
        position: 'left'
      },
      {
        type: 'value',
        name: '用户数',
        position: 'right'
      }
    ],
    series: [
      {
        name: '消费额度',
        type: 'line',
        data: data.map(item => item.dailyConsumed),
        yAxisIndex: 0
      },
      {
        name: '充值额度',
        type: 'line',
        data: data.map(item => item.dailyRecharged),
        yAxisIndex: 0
      },
      {
        name: '活跃用户',
        type: 'bar',
        data: data.map(item => item.activeUsers),
        yAxisIndex: 1
      }
    ]
  };

  const chart = echarts.init(document.getElementById('trend-chart'));
  chart.setOption(option);
}
```

### 4. 权限验证
```javascript
// 权限检查中间件
function requireAdmin(to, from, next) {
  // 检查用户是否有管理员权限
  const userRole = localStorage.getItem('userRole');
  if (userRole !== 'admin') {
    next('/403'); // 跳转到无权限页面
    return;
  }
  next();
}

// 路由配置
const routes = [
  {
    path: '/admin/analysis',
    component: AnalysisPage,
    beforeEnter: requireAdmin
  }
];
```

## 注意事项

1. **认证**: 所有接口都需要管理员权限，请确保用户已登录且具有相应权限
2. **跨域**: 开发环境需要配置代理或CORS
3. **缓存**: 建议对统计数据进行适当缓存，避免频繁请求
4. **错误处理**: 实现完善的错误处理和用户提示
5. **性能**: 大数据量展示时考虑分页或虚拟滚动
6. **实时性**: 根据业务需求决定数据刷新频率

## 示例页面结构

```vue
<template>
  <div class="analysis-dashboard">
    <!-- 概览卡片 -->
    <div class="overview-cards">
      <el-card>
        <div class="statistic">
          <div class="statistic-title">接口总数</div>
          <div class="statistic-value">{{ allInterfaceStats.length }}</div>
        </div>
      </el-card>
      <!-- 更多统计卡片 -->
    </div>

    <!-- 排行榜 -->
    <div class="rankings">
      <el-card title="接口额度消费排行榜">
        <el-table :data="interfaceRanking" v-loading="loading">
          <el-table-column prop="interfaceName" label="接口名称"/>
          <el-table-column prop="totalCreditConsumed" label="总消费额度"/>
          <el-table-column prop="userCount" label="用户数"/>
        </el-table>
      </el-card>
    </div>

    <!-- 趋势图表 -->
    <div class="charts">
      <el-card title="额度使用趋势">
        <div id="trend-chart" style="height: 400px;"></div>
      </el-card>
    </div>

    <!-- 低额度用户预警 -->
    <div class="alerts">
      <el-card title="低额度用户预警">
        <el-table :data="lowCreditUsers">
          <el-table-column prop="userName" label="用户名"/>
          <el-table-column prop="totalRemainingCredit" label="剩余额度"/>
        </el-table>
      </el-card>
    </div>
  </div>
</template>
```

这份文档提供了完整的前端接口对接指南，包含详细的请求示例、响应格式、错误处理和最佳实践建议。
