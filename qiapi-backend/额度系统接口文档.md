# QiAPI开放平台额度系统接口文档

## 概述

QiAPI开放平台额度系统为用户提供灵活的API调用额度管理机制，支持固定额度申请、积分兑换、套餐购买等多种获取额度的方式。

## 核心特性

- **固定额度申请**: 每个接口可申请100次免费调用额度
- **积分兑换**: 使用积分兑换API调用额度（10积分 = 1次调用）
- **套餐购买**: 购买不同规格的额度套餐
- **实时监控**: 额度使用情况实时统计
- **自动扣减**: API调用时自动扣减额度

## 接口列表

### 1. 申请接口免费额度

**接口地址**: `POST /credit/apply-free`

**接口描述**: 为指定接口申请100次免费调用额度，每个用户对每个接口只能申请一次。

**请求参数**:
```json
{
  "interfaceId": 1
}
```

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

**错误码**:
- `40000`: 参数错误
- `40100`: 已申请过免费额度

---

### 2. 积分兑换额度

**接口地址**: `POST /credit/exchange-points`

**接口描述**: 使用积分兑换API调用额度，兑换比例为10积分 = 1次调用。

**请求参数**:
```json
{
  "interfaceId": 1,
  "pointAmount": 100
}
```

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

**错误码**:
- `40000`: 参数错误，积分数量必须是10的倍数
- `40100`: 积分不足

---

### 3. 查询用户额度余额

**接口地址**: `GET /credit/balance`

**接口描述**: 查询当前用户所有接口的额度余额信息。

**响应示例**:
```json
{
  "code": 0,
  "data": [
    {
      "interfaceId": 1,
      "interfaceName": "获取名字",
      "totalCredit": 200,
      "usedCredit": 50,
      "remainingCredit": 150,
      "freeApplied": true,
      "status": 1,
      "expireTime": null
    }
  ],
  "message": "ok"
}
```

---

### 4. 查询用户积分余额

**接口地址**: `GET /credit/points/balance`

**接口描述**: 查询当前用户的积分余额信息。

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "totalPoints": 1000,
    "availablePoints": 800,
    "frozenPoints": 200
  },
  "message": "ok"
}
```

---

### 5. 获取额度套餐列表

**接口地址**: `GET /credit/packages`

**接口描述**: 获取所有可购买的额度套餐信息。

**响应示例**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "packageName": "基础套餐",
      "packageType": "BASIC",
      "creditAmount": 1000,
      "price": 9.90,
      "pointsPrice": 100,
      "validityDays": 365,
      "description": "适合个人开发者，提供1000次API调用额度",
      "isRecommended": false
    },
    {
      "id": 2,
      "packageName": "标准套餐",
      "packageType": "BASIC",
      "creditAmount": 5000,
      "price": 39.90,
      "pointsPrice": 400,
      "validityDays": 365,
      "description": "适合小型项目，提供5000次API调用额度",
      "isRecommended": true
    }
  ],
  "message": "ok"
}
```

---

### 6. 检查额度是否充足

**接口地址**: `GET /credit/check/{interfaceId}/{amount}`

**接口描述**: 检查用户指定接口的额度是否充足。

**路径参数**:
- `interfaceId`: 接口ID
- `amount`: 需要检查的额度数量

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 7. 初始化用户积分账户

**接口地址**: `POST /credit/points/init`

**接口描述**: 初始化用户积分账户，通常在用户注册时自动调用。

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 8. 购买额度套餐

**接口地址**: `POST /credit/purchase-package`

**接口描述**: 购买指定的额度套餐，支持现金、积分、混合支付。

**请求参数**:
```json
{
  "packageId": 1,
  "paymentType": "POINTS",
  "pointsUsed": 100
}
```

**参数说明**:
- `packageId`: 套餐ID（必填）
- `paymentType`: 支付方式，可选值：MONEY（现金）、POINTS（积分）、MIXED（混合）
- `pointsUsed`: 使用积分数量（paymentType为POINTS或MIXED时必填）

**响应示例**:
```json
{
  "code": 0,
  "data": "ORDER_1234567890",
  "message": "ok"
}
```

---

### 9. 查询用户订单列表

**接口地址**: `GET /credit/orders`

**接口描述**: 查询当前用户的所有订单，按创建时间倒序排列。

**响应示例**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "orderNo": "ORDER_1234567890",
      "packageId": 1,
      "packageName": "基础套餐",
      "creditAmount": 1000,
      "originalPrice": 9.90,
      "actualPrice": 9.90,
      "paymentType": "POINTS",
      "pointsUsed": 100,
      "moneyPaid": 0.00,
      "orderStatus": "COMPLETED",
      "paymentTime": "2024-08-23T10:30:00",
      "completionTime": "2024-08-23T10:30:05",
      "expireTime": "2024-08-23T11:00:00",
      "createTime": "2024-08-23T10:00:00"
    }
  ],
  "message": "ok"
}
```

---

### 10. 查询订单详情

**接口地址**: `GET /credit/order/{orderNo}`

**接口描述**: 根据订单号查询订单详细信息。

**路径参数**:
- `orderNo`: 订单号

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "orderNo": "ORDER_1234567890",
    "packageId": 1,
    "packageName": "基础套餐",
    "creditAmount": 1000,
    "originalPrice": 9.90,
    "actualPrice": 9.90,
    "paymentType": "POINTS",
    "pointsUsed": 100,
    "moneyPaid": 0.00,
    "orderStatus": "COMPLETED",
    "paymentTime": "2024-08-23T10:30:00",
    "completionTime": "2024-08-23T10:30:05",
    "expireTime": "2024-08-23T11:00:00",
    "createTime": "2024-08-23T10:00:00"
  },
  "message": "ok"
}
```

---

### 11. 模拟支付成功

**接口地址**: `POST /credit/order/simulate-pay/{orderNo}`

**接口描述**: 模拟订单支付成功，用于演示和测试。

**路径参数**:
- `orderNo`: 订单号

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 12. 取消订单

**接口地址**: `POST /credit/order/cancel/{orderNo}`

**接口描述**: 取消指定的订单，只能取消未完成的订单。

**路径参数**:
- `orderNo`: 订单号

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

## 数据模型

### 用户额度信息 (CreditBalanceVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| interfaceId | Long | 接口ID |
| interfaceName | String | 接口名称 |
| totalCredit | Long | 总额度 |
| usedCredit | Long | 已使用额度 |
| remainingCredit | Long | 剩余额度 |
| freeApplied | Boolean | 是否已申请免费额度 |
| status | Integer | 额度状态 0-禁用 1-正常 |
| expireTime | Date | 额度过期时间 |

### 积分余额信息 (PointBalanceVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| totalPoints | Long | 总积分 |
| availablePoints | Long | 可用积分 |
| frozenPoints | Long | 冻结积分 |

### 额度套餐信息 (CreditPackageVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 套餐ID |
| packageName | String | 套餐名称 |
| packageType | String | 套餐类型 |
| creditAmount | Long | 额度数量 |
| price | BigDecimal | 价格（元） |
| pointsPrice | Long | 积分价格 |
| validityDays | Integer | 有效期（天） |
| description | String | 套餐描述 |
| isRecommended | Boolean | 是否推荐 |

### 订单信息 (OrderVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 订单ID |
| orderNo | String | 订单号 |
| packageId | Long | 套餐ID |
| packageName | String | 套餐名称 |
| creditAmount | Long | 额度数量 |
| originalPrice | BigDecimal | 原价（元） |
| actualPrice | BigDecimal | 实际支付价格（元） |
| paymentType | String | 支付方式（MONEY/POINTS/MIXED） |
| pointsUsed | Long | 使用积分数 |
| moneyPaid | BigDecimal | 支付金额（元） |
| orderStatus | String | 订单状态（PENDING/PAID/COMPLETED/CANCELLED） |
| paymentTime | Date | 支付时间 |
| completionTime | Date | 完成时间 |
| expireTime | Date | 订单过期时间 |
| createTime | Date | 创建时间 |

## 业务规则

### 免费额度申请规则
- 每个用户对每个接口只能申请一次100次免费额度
- 免费额度永久有效（除非用户违规）
- 被封禁用户不能申请免费额度

### 积分兑换规则
- 兑换比例：10积分 = 1次API调用额度
- 积分数量必须是10的倍数
- 兑换的额度立即到账

### 积分获得规则
- 注册奖励：100积分
- 每日签到：10积分
- 接口调用：1积分/次（成功调用）
- 邀请好友：50积分
- 分享推广：20积分

### 额度消费规则
- API调用成功后自动扣减1次额度
- 优先使用额度系统，额度不足时使用旧的调用次数系统
- 调用失败不扣减额度

### 订单业务规则
- 订单有效期为30分钟，过期自动取消
- 支持三种支付方式：现金、积分、混合支付
- 混合支付时，100积分抵戱1元
- 订单支付成功后自动确认并发放额度
- 取消已支付订单会自动退还积分
- 用户只能查看和操作自己的订单

## 错误码说明

| 错误码 | 描述 |
|--------|------|
| 0 | 成功 |
| 40000 | 请求参数错误 |
| 40100 | 无权限操作 |
| 40101 | 未登录 |
| 40300 | 禁止访问 |
| 40400 | 请求数据不存在 |
| 50000 | 系统内部异常 |

## 使用示例

### 前端调用示例

```javascript
// 申请免费额度
const applyFreeCredit = async (interfaceId) => {
  const response = await fetch('/credit/apply-free', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ interfaceId })
  });
  return response.json();
};

// 查询额度余额
const getCreditBalance = async () => {
  const response = await fetch('/credit/balance');
  return response.json();
};

// 积分兑换额度
const exchangePoints = async (interfaceId, pointAmount) => {
  const response = await fetch('/credit/exchange-points', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ interfaceId, pointAmount })
  });
  return response.json();
};

// 购买额度套餐
const purchasePackage = async (packageId, paymentType, pointsUsed) => {
  const response = await fetch('/credit/purchase-package', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ packageId, paymentType, pointsUsed })
  });
  return response.json();
};

// 查询订单列表
const getUserOrders = async () => {
  const response = await fetch('/credit/orders');
  return response.json();
};

// 模拟支付成功
const simulatePayment = async (orderNo) => {
  const response = await fetch(`/credit/order/simulate-pay/${orderNo}`, {
    method: 'POST'
  });
  return response.json();
};

// 取消订单
const cancelOrder = async (orderNo) => {
  const response = await fetch(`/credit/order/cancel/${orderNo}`, {
    method: 'POST'
  });
  return response.json();
};
```

## 注意事项

1. 所有接口都需要用户登录认证
2. 额度扣减操作具有事务性，确保数据一致性
3. 系统会自动记录所有额度变动历史
4. 建议在前端展示额度余额，提醒用户及时充值
5. 积分兑换操作不可逆，请谨慎操作
6. 订单有效30分钟的有效期，过期自动取消
7. 模拟支付功能仅用于演示，生产环境需集成真实支付系统
8. 用户只能查看和操作自己的订单和额度
9. 系统支持并发操作，但建议前端做好重复提交防护

## 更新日志

### v1.0.0 (2024-08-23)
- 初始版本发布
- 支持免费额度申请
- 支持积分兑换额度
- 集成网关自动扣减机制
- 提供完整的REST API接口
- 支持额度套餐购买功能
- 实现订单管理系统
- 支持多种支付方式（现金、积分、混合）
- 添加完整的单元测试和接口文档