# QiAPI开放平台额度系统接口文档

## 概述

QiAPI开放平台额度系统为用户提供灵活的API调用额度管理机制，支持固定额度申请、积分兑换、套餐购买等多种获取额度的方式。

## 核心特性

- **固定额度申请**: 每个接口可申请100次免费调用额度
- **积分兑换**: 使用积分兑换API调用额度（10积分 = 1次调用）
- **套餐购买**: 购买不同规格的额度套餐
- **实时监控**: 额度使用情况实时统计
- **自动扣减**: API调用时自动扣减额度

## 接口列表

### 1. 申请接口免费额度

**接口地址**: `POST /credit/apply-free`

**接口描述**: 为指定接口申请100次免费调用额度，每个用户对每个接口只能申请一次。

**请求参数**:
```json
{
  "interfaceId": 1
}
```

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

**错误码**:
- `40000`: 参数错误
- `40100`: 已申请过免费额度

---

### 2. 积分兑换额度

**接口地址**: `POST /credit/exchange-points`

**接口描述**: 使用积分兑换API调用额度，兑换比例为10积分 = 1次调用。

**请求参数**:
```json
{
  "interfaceId": 1,
  "pointAmount": 100
}
```

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

**错误码**:
- `40000`: 参数错误，积分数量必须是10的倍数
- `40100`: 积分不足

---

### 3. 查询用户额度余额

**接口地址**: `GET /credit/balance`

**接口描述**: 查询当前用户所有接口的额度余额信息。

**响应示例**:
```json
{
  "code": 0,
  "data": [
    {
      "interfaceId": 1,
      "interfaceName": "获取名字",
      "totalCredit": 200,
      "usedCredit": 50,
      "remainingCredit": 150,
      "freeApplied": true,
      "status": 1,
      "expireTime": null
    }
  ],
  "message": "ok"
}
```

---

### 4. 查询用户积分余额

**接口地址**: `GET /credit/points/balance`

**接口描述**: 查询当前用户的积分余额信息。

**响应示例**:
```json
{
  "code": 0,
  "data": {
    "totalPoints": 1000,
    "availablePoints": 800,
    "frozenPoints": 200
  },
  "message": "ok"
}
```

---

### 5. 获取额度套餐列表

**接口地址**: `GET /credit/packages`

**接口描述**: 获取所有可购买的额度套餐信息。

**响应示例**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "packageName": "基础套餐",
      "packageType": "BASIC",
      "creditAmount": 1000,
      "price": 9.90,
      "pointsPrice": 100,
      "validityDays": 365,
      "description": "适合个人开发者，提供1000次API调用额度",
      "isRecommended": false
    },
    {
      "id": 2,
      "packageName": "标准套餐",
      "packageType": "BASIC",
      "creditAmount": 5000,
      "price": 39.90,
      "pointsPrice": 400,
      "validityDays": 365,
      "description": "适合小型项目，提供5000次API调用额度",
      "isRecommended": true
    }
  ],
  "message": "ok"
}
```

---

### 6. 检查额度是否充足

**接口地址**: `GET /credit/check/{interfaceId}/{amount}`

**接口描述**: 检查用户指定接口的额度是否充足。

**路径参数**:
- `interfaceId`: 接口ID
- `amount`: 需要检查的额度数量

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 7. 初始化用户积分账户

**接口地址**: `POST /credit/points/init`

**接口描述**: 初始化用户积分账户，通常在用户注册时自动调用。

**响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

## 数据模型

### 用户额度信息 (CreditBalanceVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| interfaceId | Long | 接口ID |
| interfaceName | String | 接口名称 |
| totalCredit | Long | 总额度 |
| usedCredit | Long | 已使用额度 |
| remainingCredit | Long | 剩余额度 |
| freeApplied | Boolean | 是否已申请免费额度 |
| status | Integer | 额度状态 0-禁用 1-正常 |
| expireTime | Date | 额度过期时间 |

### 积分余额信息 (PointBalanceVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| totalPoints | Long | 总积分 |
| availablePoints | Long | 可用积分 |
| frozenPoints | Long | 冻结积分 |

### 额度套餐信息 (CreditPackageVO)

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 套餐ID |
| packageName | String | 套餐名称 |
| packageType | String | 套餐类型 |
| creditAmount | Long | 额度数量 |
| price | BigDecimal | 价格（元） |
| pointsPrice | Long | 积分价格 |
| validityDays | Integer | 有效期（天） |
| description | String | 套餐描述 |
| isRecommended | Boolean | 是否推荐 |

## 业务规则

### 免费额度申请规则
- 每个用户对每个接口只能申请一次100次免费额度
- 免费额度永久有效（除非用户违规）
- 被封禁用户不能申请免费额度

### 积分兑换规则
- 兑换比例：10积分 = 1次API调用额度
- 积分数量必须是10的倍数
- 兑换的额度立即到账

### 积分获得规则
- 注册奖励：100积分
- 每日签到：10积分
- 接口调用：1积分/次（成功调用）
- 邀请好友：50积分
- 分享推广：20积分

### 额度消费规则
- API调用成功后自动扣减1次额度
- 优先使用额度系统，额度不足时使用旧的调用次数系统
- 调用失败不扣减额度

## 错误码说明

| 错误码 | 描述 |
|--------|------|
| 0 | 成功 |
| 40000 | 请求参数错误 |
| 40100 | 无权限操作 |
| 40101 | 未登录 |
| 40300 | 禁止访问 |
| 40400 | 请求数据不存在 |
| 50000 | 系统内部异常 |

## 使用示例

### 前端调用示例

```javascript
// 申请免费额度
const applyFreeCredit = async (interfaceId) => {
  const response = await fetch('/credit/apply-free', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ interfaceId })
  });
  return response.json();
};

// 查询额度余额
const getCreditBalance = async () => {
  const response = await fetch('/credit/balance');
  return response.json();
};

// 积分兑换额度
const exchangePoints = async (interfaceId, pointAmount) => {
  const response = await fetch('/credit/exchange-points', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ interfaceId, pointAmount })
  });
  return response.json();
};
```

## 注意事项

1. 所有接口都需要用户登录认证
2. 额度扣减操作具有事务性，确保数据一致性
3. 系统会自动记录所有额度变动历史
4. 建议在前端展示额度余额，提醒用户及时充值
5. 积分兑换操作不可逆，请谨慎操作

## 更新日志

### v1.0.0 (2024-08-23)
- 初始版本发布
- 支持免费额度申请
- 支持积分兑换额度
- 集成网关自动扣减机制
- 提供完整的REST API接口